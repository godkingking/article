import{j as e,c as P,B as g,r as v,h as Q,o as A,t as y,i as O,s as j}from"./index-Cfmv2_6b.js";import{H as V,S as W,T as Z,C as $}from"./theme-switch-BEuUnAg7.js";import{I as G,M as J}from"./image-mode-switch-BZ6N5lAh.js";import{u as U,f as X,F as Y,a as m,b as x,c as u,d as h,e as _,g as F}from"./form-z2H_9us6.js";import{a as ee}from"./zod-CNSUHLbF.js";import{u as M}from"./useQuery-CMxuRuqC.js";import{u as I}from"./useMutation-DZ23nx5P.js";import{r as se,u as ae,a as ne,d as te,g as re,f as le}from"./task-B-6I4xpx.js";import{u as ie}from"./index-2_VpRaJt.js";import{I as q}from"./input-DXM_P0Jl.js";import{T as ce,a as oe,b as p,c as f,d as de,e as o,S as me,f as xe,g as ue,h as he,i as je}from"./table-Bw3d3W1i.js";import{T as pe,S as fe}from"./textarea-Bv7m8Gy0.js";import{L as ge,E as Ne,R as be}from"./empty-BQG2kqd2.js";import{B as we}from"./badge-CdzfjR64.js";import{C as N,P as R}from"./confirm-button-DkBDyM36.js";import{c as z}from"./createLucideIcon-CfGVfKYJ.js";import{T as B,P as ve}from"./trash-2-CxAI5eJB.js";import{C as ye,a as _e,b as ke,c as Te,e as Ce}from"./card-5k6FjxUL.js";import{C as Se}from"./clock-ChSkGtMb.js";import"./index-BcvOfbyX.js";import"./index-LD0V451S.js";import"./index-Gxvz5Rn7.js";import"./index-Br095eJ-.js";import"./dropdown-menu-BzzqwK3A.js";import"./newspaper-ovjArt15.js";import"./scroll-area-C_xGIT5C.js";import"./index-BdQq_4o_.js";import"./arrow-right-Cdh2GvcD.js";import"./separator-DkYoixfM.js";import"./index-DyZmGQBD.js";import"./check-CtsTkJS3.js";import"./eye-B-A0tRox.js";import"./request-CKtXVA2v.js";import"./loader-circle-BuL4oDgy.js";import"./alert-dialog-CXgTf4ao.js";const Fe=[["path",{d:"M5 5a2 2 0 0 1 3.008-1.728l11.997 6.998a2 2 0 0 1 .003 3.458l-12 7A2 2 0 0 1 5 19z",key:"10ikf1"}]],D=z("play",Fe);const Me=[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]],Ie=z("zap",Me);function qe({data:n,onEdit:r,onDelete:i,onRun:l,isLoading:c}){return e.jsxs(ce,{children:[e.jsx(oe,{children:e.jsxs(p,{children:[e.jsx(f,{children:"任务名称"}),e.jsx(f,{children:"执行逻辑"}),e.jsx(f,{children:"Cron 周期"}),e.jsx(f,{children:"管理"})]})}),e.jsxs(de,{children:[c&&e.jsx(p,{children:e.jsx(o,{colSpan:9,className:"text-center",children:"加载中..."})}),n?.length===0&&e.jsx(p,{children:e.jsx(o,{colSpan:9,className:"text-center",children:"暂无数据"})}),n?.map(a=>e.jsxs(p,{children:[e.jsx(o,{children:e.jsxs("div",{className:"flex items-center gap-3 pl-2",children:[e.jsx("div",{className:P("h-2 w-2 rounded-full",a.enable?"animate-pulse bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]":"bg-slate-400 shadow-none")}),e.jsx("span",{className:"text-base font-bold",children:a.task_name})]})}),e.jsx(o,{children:e.jsxs("div",{className:"flex flex-row items-center items-end gap-2",children:[e.jsx(we,{variant:"outline",className:"font-mono",children:a.task_func}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"hidden text-xs text-muted-foreground md:inline",children:"→"}),e.jsx("span",{className:"max-w-[200px] truncate text-xs text-slate-600 md:max-w-none",children:a.task_args})]})]})}),e.jsx(o,{children:e.jsx("span",{className:"font-mono text-sm text-muted-foreground",children:a.task_cron})}),e.jsxs(o,{children:[e.jsx(N,{variant:"outline",title:"确认执行任务",description:"任务将在后台执行，请勿频繁执行任务",triggerText:e.jsx(D,{className:"h-4 w-4"}),className:"mr-2 text-emerald-700",onConfirm:()=>l(a.id)}),e.jsx(g,{variant:"outline",size:"icon",className:"mr-2",onClick:()=>r(a),children:e.jsx(R,{className:"h-4 w-4"})}),e.jsx(N,{variant:"outline",className:"mr-2 text-destructive",title:"删除任务",description:"删除后数据将无法恢复，是否确认？",triggerText:e.jsx(B,{className:"h-4 w-4"}),onConfirm:()=>i(a.id)})]})]},a.id))]})]})}function Ee({data:n,onEdit:r,onDelete:i,onRun:l,isLoading:c}){return e.jsxs("div",{className:"space-y-2",children:[c&&e.jsx(ge,{}),n?.length===0&&e.jsx(Ne,{}),n?.map(a=>e.jsxs(ye,{className:"w-full max-w-sm",children:[e.jsx(_e,{children:e.jsx(ke,{children:e.jsxs("div",{className:"flex items-center gap-3 pl-2",children:[e.jsx("div",{className:P("h-2 w-2 rounded-full",a.enable?"animate-pulse bg-green-500 shadow-[0_0_8px_rgba(34,197,94,0.4)]":"bg-slate-400 shadow-none")}),e.jsx("span",{className:"text-base font-bold",children:a.task_name})]})})}),e.jsx(Te,{children:e.jsxs("dl",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-sm text-muted-foreground",children:"执行函数"}),e.jsx("dd",{className:"text-sm",children:a.task_func})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-sm text-muted-foreground",children:"执行参数"}),e.jsx("dd",{className:"text-sm",children:a.task_args})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("dt",{className:"text-sm text-muted-foreground",children:"cron表达式"}),e.jsx("dd",{className:"text-sm",children:a.task_cron})]})]})}),e.jsxs(Ce,{className:"flex justify-end gap-2",children:[e.jsx(N,{variant:"outline",title:"确认执行任务",description:"任务将在后台执行，请勿频繁执行任务",triggerText:e.jsx(D,{className:"h-4 w-4"}),className:"text-emerald-700",onConfirm:()=>l(a.id)}),e.jsx(g,{variant:"outline",size:"icon",onClick:()=>r(a),children:e.jsx(R,{className:"h-4 w-4"})}),e.jsx(N,{variant:"outline",className:"text-destructive",title:"删除任务",description:"删除后数据将无法恢复，是否确认？",triggerText:e.jsx(B,{className:"h-4 w-4"}),onConfirm:()=>i(a.id)})]})]},a.id))]})}const Pe=A({task_name:j().min(2,"任务名称至少2个字符"),task_func:j().min(1,"请选择执行函数"),task_args:j(),task_cron:j().min(5,"请输入有效的 Cron 表达式"),enable:O()}),E={task_name:"",task_func:"",task_args:"",task_cron:"0 * * * *",enable:!0};function Re(){const[n,r]=v.useState(null),[i,l]=v.useState(!1),c=Q(),a=ie(),{data:b,isLoading:k}=M({queryKey:["tasks"],queryFn:async()=>(await re()).data,staleTime:300*1e3}),w=I({mutationFn:async s=>n?await ae({...s,id:n.id}):await ne({...s,id:0}),onSuccess:s=>{y.success(s.message),c.invalidateQueries({queryKey:["tasks"]}),l(!1),r(null)}}),L=I({mutationFn:te,onSuccess:s=>{y.success(s.message),c.invalidateQueries({queryKey:["tasks"]})}}),{data:T}=M({queryKey:["taskFunc"],queryFn:async()=>(await le()).data,staleTime:300*1e3}),t=U({resolver:ee(Pe),defaultValues:E}),H=X({control:t.control,name:"task_func"}),K=T?.find(s=>s.func_name===H)?.func_args;v.useEffect(()=>{n?t.reset(n):i&&t.reset(E)},[n,i,t]);const C=async s=>{L.mutate(s)},S=async s=>{const d=await se(s);y.success(d.message)};return e.jsxs("div",{className:"flex h-full flex-col overflow-hidden",children:[e.jsx("div",{className:"sticky top-0 z-10 mb-2",children:e.jsxs("div",{className:"flex items-center justify-between rounded-2xl border p-4 shadow-sm md:p-6",children:[e.jsx("div",{className:"space-y-1",children:e.jsxs("p",{className:"flex items-center gap-1 text-xs text-muted-foreground md:text-sm",children:[e.jsx(Ie,{className:"h-3 w-3 fill-amber-500 text-amber-500"}),"当前活跃任务: ",b?.filter(s=>s.enable).length]})}),e.jsx(be,{title:n?"编辑任务":"创建新任务",open:i,onOpenChange:l,trigger:e.jsxs(g,{onClick:()=>r(null),className:"rounded-full",children:[e.jsx(ve,{})," 新增任务"]}),children:e.jsx(Y,{...t,children:e.jsxs("form",{onSubmit:t.handleSubmit(s=>{w.mutate(s)}),className:"space-y-4",children:[e.jsx(m,{control:t.control,name:"task_name",render:({field:s})=>e.jsxs(x,{children:[e.jsx(u,{children:"任务名称"}),e.jsx(h,{children:e.jsx(q,{placeholder:"输入任务名称",...s})}),e.jsx(_,{})]})}),e.jsx(m,{control:t.control,name:"task_func",render:({field:s})=>e.jsxs(x,{children:[e.jsx(u,{children:"执行函数"}),e.jsx(h,{children:e.jsxs(me,{onValueChange:s.onChange,value:s.value,children:[e.jsx(xe,{className:"w-full",children:e.jsx(ue,{placeholder:"选择函数"})}),e.jsx(he,{className:"w-full",children:T?.map(d=>e.jsx(je,{value:d.func_name,children:d.func_label},d.func_name))})]})})]})}),e.jsx(m,{control:t.control,name:"task_args",render:({field:s})=>e.jsxs(x,{children:[e.jsx(u,{children:"函数参数"}),e.jsx(h,{children:e.jsx(pe,{...s,placeholder:'{"arg_name":"arg_value"}'})}),e.jsx(F,{children:e.jsxs("span",{children:["参数列表: ",K]})})]})}),e.jsx(m,{control:t.control,name:"task_cron",render:({field:s})=>e.jsxs(x,{children:[e.jsx(u,{children:"Cron 表达式"}),e.jsx(h,{children:e.jsxs("div",{className:"relative",children:[e.jsx(q,{...s}),e.jsx(Se,{className:"absolute top-1/2 right-3 h-4 w-4 -translate-y-1/2 text-muted-foreground"})]})}),e.jsxs(F,{children:[e.jsx("span",{className:"rounded bg-muted px-1.5 py-0.5 italic",children:"*/5 * * * * (每5分)"}),e.jsx("span",{className:"rounded bg-muted px-1.5 py-0.5 italic",children:"0 0 * * * (每日)"})]}),e.jsx(_,{})]})}),e.jsx(m,{control:t.control,name:"enable",render:({field:s})=>e.jsxs(x,{className:"flex items-center justify-between",children:[e.jsx(u,{children:"开启任务"}),e.jsx(h,{children:e.jsx(fe,{checked:s.value,onCheckedChange:s.onChange})}),e.jsx(_,{})]})}),e.jsx(g,{type:"submit",disabled:w.isPending,className:"w-full",children:w.isPending?"保存中...":"保存配置"})]})})})]})}),e.jsx("div",{className:"flex-1 overflow-auto rounded-lg border",children:a?e.jsx(Ee,{data:b,isLoading:k,onRun:S,onDelete:C,onEdit:s=>{r(s),l(!0)}}):e.jsx(qe,{data:b,isLoading:k,onRun:S,onDelete:C,onEdit:s=>{r(s),l(!0)}})})]})}function ze(){return e.jsxs(e.Fragment,{children:[e.jsxs(V,{fixed:!0,children:[e.jsx(W,{}),e.jsxs("div",{className:"ms-auto flex items-center space-x-4",children:[e.jsx(G,{}),e.jsx(Z,{}),e.jsx($,{})]})]}),e.jsxs(J,{fixed:!0,children:[e.jsx("div",{className:"flex flex-wrap items-end justify-between gap-2",children:e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold tracking-tight",children:"任务调度管理"}),e.jsx("p",{className:"text-muted-foreground",children:"配置并监控自动执行的定时任务"})]})}),e.jsx(Re,{})]})]})}const gs=ze;export{gs as component};
